{% extends request.args.get('layout', 'layout.html') %}

{% block content %}
<div class="h-full w-full flex flex-col relative" x-data="notesApp('{{ note_id }}')" x-init="init()">

    <div class="absolute top-4 w-full z-[100] flex items-center justify-between px-6 pointer-events-none">
        <a href="/" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true"
           class="pointer-events-auto flex items-center gap-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur-md px-4 py-2 rounded-full border border-white/20 shadow-sm font-bold text-sm hover:scale-105 transition-transform">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            <span>Exit</span>
        </a>
        
        <div class="pointer-events-auto px-5 py-2 rounded-full bg-white/80 dark:bg-slate-800/80 border border-white/20 backdrop-blur-md shadow-sm text-xs font-bold flex items-center gap-2 overflow-hidden max-w-md">
             <template x-for="(crumb, idx) in viewData.breadcrumbs" :key="crumb.id">
                <div class="flex items-center gap-2">
                    <span @click="loadNote(crumb.id)" 
                          class="cursor-pointer hover:text-blue-500 transition-colors"
                          :class="idx === viewData.breadcrumbs.length - 1 ? 'opacity-100 underline decoration-blue-500' : 'opacity-50'"
                          x-text="crumb.name"></span>
                    <span x-show="idx < viewData.breadcrumbs.length - 1" class="opacity-30">/</span>
                </div>
             </template>
        </div>

        <button @click="toggleAI()" class="pointer-events-auto px-4 py-2 rounded-full border border-white/20 transition-all duration-300 backdrop-blur-md shadow-sm flex items-center gap-2 group font-bold" 
                :class="aiOpen ? 'bg-blue-500 text-white border-blue-500' : 'bg-white/80 dark:bg-slate-800/80 hover:bg-white dark:hover:bg-slate-700'">
            <span>AI Assist</span>
            <div class="w-2 h-2 rounded-full" :class="aiOpen ? 'bg-white animate-pulse' : 'bg-green-500'"></div>
        </button>
    </div>

    <div class="flex-1 flex overflow-hidden relative h-full pt-16">
        {% include 'components/notes_sidebar.html' %}
        {% include 'components/notes_editor.html' %}
        {% include 'components/quiz_sidebar_right.html' %}
    </div>

    {% include 'components/quiz_modals.html' %}

    <div x-show="showAutoSaveNotify"
         class="toast-autosave"
         style="display: none;">
         <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse shadow-[0_0_10px_#22c55e]"></div>
         <span x-text="saveNotifyText" class="tracking-wider"></span>
    </div>

    <div x-show="ctxMenu.show" 
         @click.stop
         x-transition:enter="transition ease-out duration-100"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         class="fixed z-[999] min-w-[180px] glass-panel shadow-2xl border border-white/20 overflow-hidden flex flex-col py-1"
         :style="`top: ${ctxMenu.y}px; left: ${ctxMenu.x}px`"
         style="display: none;">
         
         <div x-show="ctxMenu.type === 'item'">
             <div class="px-4 py-2 text-[10px] font-bold uppercase opacity-50 tracking-wider border-b border-white/10 mb-1" x-text="ctxMenu.item?.type"></div>
             <button @click="openRenameModal()" class="w-full px-4 py-2 text-sm font-bold text-left hover:bg-blue-500 hover:text-white transition-colors flex items-center gap-3">
                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                 Rename
             </button>
             <button @click="openMoveModal()" class="w-full px-4 py-2 text-sm font-bold text-left hover:bg-blue-500 hover:text-white transition-colors flex items-center gap-3">
                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                 Move to...
             </button>
             <div class="h-px bg-white/10 my-1"></div>
             <button @click="deleteItem()" class="w-full px-4 py-2 text-sm font-bold text-left hover:bg-red-500 hover:text-white text-red-500 transition-colors flex items-center gap-3">
                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                 Delete
             </button>
         </div>

         <div x-show="ctxMenu.type === 'blank'">
             <div class="px-4 py-2 text-[10px] font-bold uppercase opacity-50 tracking-wider border-b border-white/10 mb-1">Folder Options</div>
             <button @click="showCreateModal = true; ctxMenu.show = false" class="w-full px-4 py-2 text-sm font-bold text-left hover:bg-blue-500 hover:text-white transition-colors flex items-center gap-3">
                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                 New Item
             </button>
             <div class="h-px bg-white/10 my-1"></div>
             <div class="px-4 py-1 text-[10px] font-bold opacity-40">Sort By</div>
             <button @click="sortItems('name'); ctxMenu.show = false" class="w-full px-4 py-2 text-sm font-bold text-left hover:bg-blue-500 hover:text-white transition-colors flex items-center gap-3">
                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"></path></svg>
                 Name (A-Z)
             </button>
             <button @click="sortItems('time'); ctxMenu.show = false" class="w-full px-4 py-2 text-sm font-bold text-left hover:bg-blue-500 hover:text-white transition-colors flex items-center gap-3">
                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                 Time (Newest)
             </button>
         </div>
    </div>

    <div x-show="renameModal.show" 
         class="fixed inset-0 z-[1000] flex items-center justify-center bg-black/60 backdrop-blur-sm"
         x-transition.opacity
         @click="renameModal.show = false"
         style="display: none;">
        <div @click.stop class="glass-panel p-6 w-full max-w-sm shadow-2xl bg-white dark:bg-slate-800 transform transition-all scale-100">
            <h3 class="font-bold text-lg mb-4">Rename Item</h3>
            <input type="text" x-model="renameModal.name" @keydown.enter="confirmRename()" class="w-full p-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent mb-4 focus:ring-2 focus:ring-blue-500 outline-none font-bold" autofocus>
            <div class="flex gap-2">
                <button @click="renameModal.show = false" class="flex-1 py-2 bg-gray-100 dark:bg-white/10 rounded-lg font-bold opacity-70 hover:opacity-100">Cancel</button>
                <button @click="confirmRename()" class="flex-1 py-2 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600">Save</button>
            </div>
        </div>
    </div>

    <div x-show="moveModal.show" 
         class="fixed inset-0 z-[1000] flex items-center justify-center bg-black/60 backdrop-blur-sm"
         x-transition.opacity
         @click="moveModal.show = false"
         style="display: none;">
        
        <div @click.stop class="glass-panel w-full max-w-md h-[500px] flex flex-col shadow-2xl bg-white dark:bg-slate-800 transform transition-all scale-100">
            <div class="p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="font-bold text-lg">Move to...</h3>
                <button @click="moveModal.show = false" class="p-1 hover:bg-white/10 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            
            <div class="px-4 py-2 flex gap-1 text-xs opacity-60 border-b border-white/5 overflow-x-auto no-scrollbar">
                <template x-for="(crumb, i) in moveModal.currentPath" :key="crumb.id">
                    <div class="flex gap-1 shrink-0">
                        <span @click="loadMovePicker(crumb.id)" class="hover:underline cursor-pointer hover:text-blue-500" x-text="crumb.name"></span>
                        <span x-show="i < moveModal.currentPath.length - 1">/</span>
                    </div>
                </template>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-2">
                <div x-show="moveModal.currentPath.length > 1" 
                     @click="loadMovePicker(moveModal.currentPath[moveModal.currentPath.length - 2].id)"
                     class="p-2 px-4 rounded-xl cursor-pointer hover:bg-gray-100 dark:hover:bg-white/5 flex items-center gap-2 opacity-60 hover:opacity-100 text-xs font-bold mb-2 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Back
                </div>

                <template x-for="item in moveModal.items" :key="item.id">
                    <div @click="loadMovePicker(item.id)" class="p-3 rounded-xl cursor-pointer bg-gray-50 dark:bg-white/5 hover:bg-blue-500 hover:text-white transition-colors flex items-center gap-3 group">
                        <svg class="w-5 h-5 text-blue-500 group-hover:text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"></path></svg>
                        <span class="font-bold text-sm flex-1" x-text="item.name"></span>
                        <svg class="w-4 h-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                </template>

                <div x-show="moveModal.items.length === 0" class="text-center opacity-30 py-10 text-xs font-bold uppercase">
                    No subfolders
                </div>
            </div>

            <div class="p-4 border-t border-white/10 bg-gray-50 dark:bg-black/20 flex justify-between items-center">
                <div class="text-xs opacity-50">Current: <span x-text="moveModal.currentPath[moveModal.currentPath.length-1]?.name">Root</span></div>
                <button @click="confirmMove()" class="px-6 py-2 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition-colors shadow-lg">
                    Move Here
                </button>
            </div>
        </div>
    </div>

    <div x-show="showNotePicker" 
         class="fixed inset-0 z-[1000] flex items-center justify-center bg-black/60 backdrop-blur-sm"
         x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
         @click="showNotePicker = false"
         style="display: none;">
        <div @click.stop class="glass-panel w-full max-w-md h-[500px] flex flex-col shadow-2xl bg-white dark:bg-slate-800 border border-white/10">
            <div class="p-4 border-b border-white/10">
                <input type="text" x-model="noteSearchQuery" class="w-full bg-gray-100 dark:bg-white/5 border-none rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-blue-500 font-medium" placeholder="Search notes to link..." autofocus>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                <template x-for="note in noteSearchResults" :key="note.id">
                    <div @click="insertNoteLink(note)" class="p-3 rounded-xl cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors group">
                        <div class="font-bold text-sm text-slate-700 dark:text-slate-200 group-hover:text-blue-600" x-text="note.name"></div>
                        <div class="text-xs opacity-40 truncate font-mono mt-0.5" x-text="note.preview"></div>
                    </div>
                </template>
                <div x-show="noteSearchResults.length === 0" class="p-8 text-center opacity-30 text-sm font-bold">No notes found</div>
            </div>
        </div>
    </div>

    <div x-show="showQuestionPicker" 
         class="fixed inset-0 z-[120] flex items-center justify-center bg-black/60 backdrop-blur-sm" 
         x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
         @click="showQuestionPicker = false"
         style="display: none;">
        <div @click.stop class="glass-panel w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl bg-white dark:bg-slate-800 border border-white/10">
            <div class="p-6 border-b border-gray-200 dark:border-white/10 flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-lg">Import Question</h3>
                    <div class="flex gap-1 text-xs mt-1 opacity-50">
                        <template x-for="(crumb, i) in pickerData.breadcrumbs" :key="crumb.id">
                            <div class="flex gap-1"><span @click="loadPickerData(crumb.id)" class="hover:underline cursor-pointer hover:text-blue-500" x-text="crumb.name"></span><span x-show="i < pickerData.breadcrumbs.length - 1">/</span></div>
                        </template>
                    </div>
                </div>
                <button @click="showQuestionPicker = false" class="p-2 hover:bg-gray-100 dark:hover:bg-white/10 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar">
                <div x-show="pickerData.breadcrumbs.length > 1" @click="loadPickerData(pickerData.breadcrumbs[pickerData.breadcrumbs.length - 2].id)" class="p-2 px-4 rounded-xl cursor-pointer hover:bg-gray-100 dark:hover:bg-white/5 flex items-center gap-2 opacity-60 hover:opacity-100 text-xs font-bold mb-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg> Back
                </div>
                <template x-for="sub in pickerData.sub_notebooks" :key="sub.id">
                     <div @click="loadPickerData(sub.id)" class="p-3 rounded-xl cursor-pointer flex items-center gap-3 hover:bg-yellow-500/10 text-yellow-600 dark:text-yellow-500 border border-transparent hover:border-yellow-500/30">
                         <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"></path></svg>
                         <div class="flex-1 font-bold text-sm" x-text="sub.name"></div>
                     </div>
                </template>
                <template x-for="q in pickerData.questions" :key="q.id">
                    <div @click="insertQuestionRef(q.id)" class="p-4 rounded-xl border border-gray-200 dark:border-white/10 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer transition-colors group">
                        <div class="flex justify-between mb-1"><span class="text-xs font-bold opacity-50" x-text="q.id"></span><div class="flex gap-1"><template x-for="tag in q.tags"><span class="px-1.5 py-0.5 rounded bg-gray-200 dark:bg-white/10 text-[10px]" x-text="tag"></span></template></div></div>
                        <div class="text-sm font-medium truncate" x-text="q.summary"></div>
                    </div>
                </template>
                <div x-show="pickerData.sub_notebooks.length === 0 && pickerData.questions.length === 0" class="text-center p-8 opacity-50">Empty Folder</div>
            </div>
        </div>
    </div>

    <div x-show="showCreateModal" 
         class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm"
         x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
         @click="showCreateModal = false"
         style="display: none;">
        
        <div @click.stop 
             class="glass-panel p-8 w-full max-w-sm shadow-2xl bg-white dark:bg-slate-800 transform transition-all scale-100 border border-white/10">
            
            <h3 class="font-bold text-xl mb-6">Create Item</h3>
            
            <div class="flex p-1 bg-gray-100 dark:bg-white/5 rounded-xl mb-6">
                <button @click="newItemType='folder'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all duration-300" :class="newItemType==='folder' ? 'bg-white dark:bg-slate-700 shadow-sm text-blue-500' : 'opacity-50 hover:opacity-100'">Folder</button>
                <button @click="newItemType='file'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all duration-300" :class="newItemType==='file' ? 'bg-white dark:bg-slate-700 shadow-sm text-green-500' : 'opacity-50 hover:opacity-100'">Note File</button>
            </div>

            <label class="text-xs font-bold opacity-50 uppercase mb-2 block">Name</label>
            
            <input type="text" 
                   x-model="newItemName" 
                   @keydown.enter.prevent="createItem()"
                   class="w-full p-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-white/5 mb-6 focus:ring-2 focus:ring-blue-500 outline-none font-medium transition-all"
                   placeholder="Enter name..."
                   autofocus>
            
            <div class="flex gap-3">
                <button @click="showCreateModal = false" class="flex-1 py-3 bg-gray-100 dark:bg-white/5 rounded-xl font-bold opacity-70 hover:opacity-100 transition-colors">Cancel</button>
                <button @click="createItem()" class="flex-1 py-3 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 hover:scale-[1.02] transition-all shadow-lg shadow-blue-500/30">Create</button>
            </div>
        </div>
    </div>

    <div x-show="showAddToBookModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm" style="display: none;">
        <div @click.away="showAddToBookModal = false" class="glass-panel p-6 w-full max-w-sm shadow-2xl bg-white dark:bg-slate-800 transform transition-all scale-100">
            <h3 class="font-bold text-lg mb-4" x-text="t('add_to_notebook')">Add to Notebook</h3>
            <div class="max-h-60 overflow-y-auto space-y-2 mb-4 pr-2">
                <template x-for="book in notebooksList" :key="book.id">
                    <div @click="addToBook(book.id)" class="p-3 rounded-xl bg-gray-50 dark:bg-white/5 hover:bg-blue-500 hover:text-white cursor-pointer font-medium text-sm transition-colors" x-text="book.name"></div>
                </template>
            </div>
            <button @click="showAddToBookModal = false" class="w-full py-2 bg-gray-100 dark:bg-white/10 rounded-lg font-bold opacity-70 hover:opacity-100" x-text="t('cancel')">Cancel</button>
        </div>
    </div>

</div>
{% endblock %}